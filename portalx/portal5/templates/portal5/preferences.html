{% extends 'portal5/components/portal5.html' %}

{% set title = 'portal5:preferences' %}

{% block styles %}
{{ super() }}
<style>
    h5 {
        margin: 0;
        display: flex;
        margin: 0 5pt 0;
    }

    button {
        border: none;
        margin: 0;
        text-align: center;
        vertical-align: middle;
        font-family: 'Fira Code', monospace;
        font-weight: 700;
        flex-shrink: 0;
        cursor: pointer;
        height: 1.4rem;
        width: 3rem;
        font-size: 12pt;
    }

    label {
        display: inline-block;
        cursor: pointer;
    }

    .option {
        display: flex;
        width: 100%;
        flex-direction: row;
        justify-content: space-between;
        margin: 1rem 0 0 0;
    }

    .option-row {
        display: flex;
        width: 100%;
        flex-direction: column;
    }

    .option-description {
        margin: 0 0 0 1.5rem;
    }

    .option-bullet {
        display: inline-block;
        margin: 0 5pt auto 0;
    }

    .rotate-90d {
        transform: rotate(90deg);
    }

    .collapsed {
        display: none;
    }

    .form-footer {
        display: flex;
        justify-content: flex-end;
        margin: 2rem 0 0.5rem 0;
    }

    .form-footer button {
        width: initial;
        height: 2rem;
        font-size: 16pt;
    }

    .form-footer p {
        margin: 0 1rem 0 0;
    }

    .form-postscript {
        display: flex;
        align-items: flex-end;
        flex-flow: column;
    }

    .form-postscript * {
        width: max-content;
    }

    .form-postscript h6 {
        margin: 0.5rem 0;
        text-align: end;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    window.addEventListener('load', () => {
        document.querySelectorAll('label').forEach((l) => {
            l.addEventListener('click', (ev) => {
                const label = ev.target
                const option = label.closest('.option-row')
                const description = option.querySelector('.option-description')
                description.classList.toggle('collapsed')
                option.querySelector('.option-bullet').classList.toggle('rotate-90d')
            })
        })
        document.querySelectorAll('.toggle-button').forEach((btn) => {
            btn.addEventListener('click', (ev) => {
                const button = ev.target
                const option = button.closest('.option-row')
                const input = option.querySelector('input')
                let value = input.value ^ 1
                if (value) {
                    button.classList.replace('color-gray-bg', `color-${button.dataset.color}-bg`)
                } else {
                    button.classList.replace(`color-${button.dataset.color}-bg`, 'color-gray-bg')
                }
                button.textContent = value ? 'on' : 'off'
                input.value = value
            })
        })
    });
</script>
{% if updated %}
<script>
    const version = '{{ version }}'
    window.addEventListener('load', () => history.replaceState("", "", "/settings"));
    window.addEventListener('load', async () => {
        if ('serviceWorker' in navigator) {
            let registration = await navigator.serviceWorker.getRegistration()
            await registration.unregister()
            await navigator.serviceWorker.register(`/service-worker.${version}.js`, { scope: '/' })
        }
    });
</script>
{% endif %}
{% endblock %}

{% block main %}

<form action="/settings" method="POST">

    {% for section_name, options in prefs.items() %}
    <h2>{{ section_name }}</h2>

    {% for option_id, details in options.items() %}
    {% set color = details.color|default('green') %}

    <div id="{{ option_id|replace('_', '-') }}" class="option-row">
        <div class="option">
            <input type="hidden" name="{{ option_id }}" value="{{ details.enabled|int }}" />
            <h5><span class="option-bullet">â€£</span><label>{{ details.name|safe }}</label></h5>
            <button type="button" class="toggle-button color-{{ color if details.enabled else 'gray' }}-bg" data-color="{{ color }}">
                {{- 'on' if details.enabled else 'off' -}}
            </button>
        </div>
        <div class="option-description collapsed">
            <p>{{ details.desc|safe }}</p>
        </div>
    </div>

    {% endfor %}
    {% endfor %}

    <div class="form-footer">
        {% if updated %}
        <p class="color-green-fg">Your preferences have been updated.</p>
        {% endif %}
        <button type="submit" name="action" value="update" class="color-cyan-bg">Save preferences</button>
    </div>
    <div class="form-postscript">
        <button type="submit" name="action" value="reset" class="color-gray-bg">Reset defaults</button>
        <h6>Your preferences are saved using cookies.<br> They remain effective until you clear the data for this site.</h6>
    </div>

</form>

{% endblock %}